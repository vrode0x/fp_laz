!function(e){"use strict";var f=Promise;if(void 0===f&&(f=e.Promise),void 0===f)throw"Promise is not supported! Use latest version node/browser or promise-polyfill";function d(e){return void 0===e}function p(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}function m(e){return"function"==typeof e}function l(e){return"string"==typeof e}function h(e){if(p(e)){for(var r in e)if(e.hasOwnProperty(r))return!1;return!0}return v(e)?!e.length:!e}function g(e,r){if(v(e))return e.map(r);for(var n in e)e.hasOwnProperty(n)&&r(e[n])}var v=Array.isArray,y={PARSE_ERROR:{code:-32700,message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},INVALID_REQUEST:{code:-32600,message:"Invalid Request. The JSON sent is not a valid Request object."},METHOD_NOT_FOUND:{code:-32601,message:"Method not found. The method does not exist / is not available."},INVALID_PARAMS:{code:-32602,message:"Invalid params. Invalid method parameter(s)."},INTERNAL_ERROR:{code:-32603,message:"Internal error. Internal JSON-RPC error."}};function O(e,r,n){this.message=r||"",this.code=e||-32e3,Boolean(n)&&(this.data=n)}O.prototype=new Error;function r(){var o=this,t={},s=0,i={};function a(e,r){var n=function(e){return JSON.parse(JSON.stringify(e))}(e);return r&&(p(r)&&r.hasOwnProperty("message")?n.data=r.message:l(r)&&(n.data=r),r instanceof O&&(n={message:r.message,code:r.code},r.hasOwnProperty("data")&&(n.data=r.data))),n}function n(e){try{return function(e){return!!e.error}(e)?function(e){t.hasOwnProperty(e.id)?t[e.id].reject(e.error):console.log("Unknown request",e)}(e):function(e){return e.hasOwnProperty("result")&&e.hasOwnProperty("id")}(e)?function(e){t.hasOwnProperty(e.id)?(t[e.id].resolve(e.result),delete t[e.id]):console.log("unknown request",e)}(e):function(e){return!!e.method}(e)?function(r){{if(!i.hasOwnProperty(r.method))return f.resolve({jsonrpc:"2.0",id:r.id,error:a(y.METHOD_NOT_FOUND,{message:r.method})});try{var e;if(r.hasOwnProperty("params")){if("pass"==i[r.method].params)e=i[r.method].fn.call(i,r.params);else if(v(r.params))e=i[r.method].fn.apply(i,r.params);else if(p(r.params)){if(!(i[r.method].params instanceof Array))return f.resolve({jsonrpc:"2.0",id:r.id,error:a(y.INVALID_PARAMS,"Undeclared arguments of the method "+r.method)});var n=[];if(i[r.method].params.forEach(function(e){r.params.hasOwnProperty(e)?(n.push(r.params[e]),delete r.params[e]):n.push(void 0)}),0<Object.keys(r.params).length)return f.resolve({jsonrpc:"2.0",id:r.id,error:a(y.INVALID_PARAMS,{message:"Params: "+Object.keys(r.params).toString()+" not used"})});e=i[r.method].fn.apply(i,n)}}else e=i[r.method].fn();return r.hasOwnProperty("id")?function(e){return!!e&&"function"==typeof e.then}(e)?e.then(function(e){return d(e)&&(e=!0),{jsonrpc:"2.0",id:r.id,result:e}}).catch(function(e){return{jsonrpc:"2.0",id:r.id,error:a(y.INTERNAL_ERROR,e)}}):(d(e)&&(e=!0),f.resolve({jsonrpc:"2.0",id:r.id,result:e})):f.resolve()}catch(e){return f.resolve({jsonrpc:"2.0",id:r.id,error:a(y.INTERNAL_ERROR,e)})}}}(e):f.resolve({id:null,jsonrpc:"2.0",error:a(y.INVALID_REQUEST)})}catch(e){return console.error("Resolver error:"+e.message,e),f.reject(e)}}function u(e,r){var n={jsonrpc:"2.0",method:e,params:r};return p(r)&&!h(r)&&(n.params=r),n}function c(e,r){var n={jsonrpc:"2.0",method:e,id:s+=1};return p(r)&&!h(r)&&(n.params=r),{promise:new f(function(e,r){t[s.toString()]={resolve:e,reject:r}}),message:n}}o.toStream=function(e){console.log("Need define the toStream method before use"),console.log(arguments)},o.dispatch=function(e,r,n){if(l(e)&&"pass"==r&&m(n))i[e]={fn:n,params:r};else if(l(e)&&v(r)&&m(n))i[e]={fn:n,params:r};else{if(!(l(e)&&m(r)&&d(n)))throw new Error("Missing required argument: functionName - string, paramsNameFn - string or function");i[e]={fn:r,params:null}}},o.on=o.dispatch,o.off=function(e){delete i[e]},o.call=function(e,r){var n=c(e,r);return o.toStream(JSON.stringify(n.message)),n.promise},o.notification=function(e,r){o.toStream(JSON.stringify(u(e,r)))},o.batch=function(e){var n=[],t=[];return g(e,function(e){if(e.hasOwnProperty("call")){var r=c(e.call.method,e.call.params);t.push(r.message),n.push(r.promise.then(function(e){return e},function(e){return e}))}else e.hasOwnProperty("notification")&&t.push(u(e.notification.method,e.notification.params))}),o.toStream(JSON.stringify(t)),f.all(n)},o.messageHandler=function(e){try{return function(e){var r=[];return v(e)?g(e,function(e){r.push(n(e))}):p(e)&&r.push(n(e)),f.all(r).then(function(e){var r=[];return g(e,function(e){d(e)||r.push(e)}),1===r.length?o.toStream(JSON.stringify(r[0])):1<r.length&&o.toStream(JSON.stringify(r)),e})}(JSON.parse(e))}catch(e){return console.log("Error in messageHandler(): ",e),o.toStream(JSON.stringify({id:null,jsonrpc:"2.0",error:y.PARSE_ERROR})),f.reject(e)}},o.customException=function(e,r,n){return new O(e,r,n)}}if("function"==typeof define&&define.amd)define("simple_jsonrpc",[],function(){return r});else if("undefined"!=typeof module&&void 0!==module.exports)module.exports=r;else{if(void 0===e)return;e.simple_jsonrpc=r}}(this);